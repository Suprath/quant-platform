services:
  # LAYER 2: MESSAGE BUS (The "Heart" of the system)
  kafka:
    image: apache/kafka:latest
    container_name: kafka_bus
    ports:
      - "9094:9094"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=INTERNAL://0.0.0.0:9092,EXTERNAL://0.0.0.0:9094,CONTROLLER://0.0.0.0:9093
      - KAFKA_ADVERTISED_LISTENERS=INTERNAL://kafka_bus:9092,EXTERNAL://localhost:9094
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka_bus:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_LOG_DIRS=/var/lib/kafka/data
    volumes:
      - kafka_data:/var/lib/kafka/data
    restart: always

  ingestor:
    build: ../services/ingestion
    container_name: upstox_ingestor
    depends_on:
      - kafka  # REMOVED: condition: service_healthy
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka_bus:9092
      - PYTHONUNBUFFERED=1
    volumes:
      - ../services/ingestion:/app
    env_file:
      - ../services/ingestion/.env
    restart: always

  # LAYER 2: STATE STORE & CACHE
  redis:
    image: redis:7-alpine
    container_name: redis_state
    ports:
      - "6379:6379"
    restart: always

  # LAYER 3: TIME-SERIES STORAGE (Tick & OHLC Data)
  questdb:
    image: questdb/questdb:latest
    container_name: questdb_tsdb
    ports:
      - "9000:9000"
      - "8812:8812"
    volumes:
      - questdb_data:/var/lib/questdb
    restart: always

  # LAYER 3: RELATIONAL STORAGE (Users & Strategies)
  postgres:
    image: postgres:15-alpine
    container_name: postgres_metadata
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password123
      - POSTGRES_DB=quant_platform
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

  # LAYER 3: OBJECT STORAGE (Strategy Code & Backtest results)
  minio:
    image: minio/minio:latest
    container_name: minio_s3
    command: server /data --console-address ":9001"
    ports:
      - "9005:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password123
    volumes:
      - minio_data:/data
    restart: always

  persistor:
    build: ../services/persistor
    container_name: market_persistor
    depends_on:
      - kafka
      - questdb
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka_bus:9092
      - PYTHONUNBUFFERED=1
    restart: always 

  feature_engine:
    build: ../services/feature_engine
    container_name: feature_engine
    depends_on:
      - kafka
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka_bus:9092
      - PYTHONUNBUFFERED=1
    volumes:
      - ../services/feature_engine:/app
    restart: always

  strategy_runtime:
    build: ../services/strategy_runtime
    container_name: strategy_runtime
    depends_on:
      - kafka
      - postgres
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka_bus:9092
      - PYTHONUNBUFFERED=1
      - STRATEGY_NAME
      - STRATEGY_PARAMS
    volumes:
      - ../services/strategy_runtime:/app
    restart: always

  api_gateway:
    build: ../services/api_gateway
    container_name: api_gateway
    volumes:
      - ../services/api_gateway:/app
    depends_on:
      - postgres
      - questdb
    ports:
      - "8080:8000"
    restart: always

  backfiller:
    build: ../services/backfiller
    container_name: data_backfiller
    depends_on:
      - questdb
    env_file:
      - ../services/ingestion/.env

  scanner:
    build: ../services/scanner
    container_name: market_scanner
    depends_on:
      - kafka
      - postgres
    env_file:
      - ../services/ingestion/.env
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka_bus:9092
    volumes:
      - ../services/scanner:/app
    restart: always

  doctor:
    build: ../services/system_doctor
    container_name: system_doctor
    depends_on:
      - postgres
      - questdb
      - kafka
      - api_gateway

  historical_replayer:
    build: ../services/historical_replayer
    container_name: historical_replayer
    depends_on:
      - kafka
      - questdb
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka_bus:9092
    volumes:
      - ../services/historical_replayer:/app
    profiles: ["replay"]  # Only start when explicitly requested

  grafana:
    image: grafana/grafana:latest
    container_name: quant_grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards/json
    depends_on:
      - questdb
      - postgres
    restart: always

volumes:
  questdb_data:
  postgres_data:
  minio_data:
  kafka_data:
  grafana_data: