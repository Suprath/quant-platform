services:
  # LAYER 2: MESSAGE BUS (The "Heart" of the system)
  kafka:
    image: apache/kafka:latest
    container_name: kafka_bus
    ports:
      - "9094:9094" # Port for your Mac
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=INTERNAL://:9092,EXTERNAL://:9094,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=INTERNAL://kafka_bus:9092,EXTERNAL://localhost:9094
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka_bus:9093 # Fixed: Use container name
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0

  # LAYER 2: STATE STORE & CACHE
  redis:
    image: redis:7-alpine
    container_name: redis_state
    ports:
      - "6379:6379"
    restart: always

  # LAYER 3: TIME-SERIES STORAGE (Tick & OHLC Data)
  questdb:
    image: questdb/questdb:latest
    container_name: questdb_tsdb
    ports:
      - "9000:9000" # Web Console (QuestDB UI)
      - "8812:8812" # Postgres Wire Protocol (Inbound Data)
    volumes:
      - questdb_data:/var/lib/questdb
    restart: always

  # LAYER 3: RELATIONAL STORAGE (Users & Strategies)
  postgres:
    image: postgres:15-alpine
    container_name: postgres_metadata
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password123
      - POSTGRES_DB=quant_platform
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

  # LAYER 3: OBJECT STORAGE (Strategy Code & Backtest results)
  minio:
    image: minio/minio:latest
    container_name: minio_s3
    command: server /data --console-address ":9001"
    ports:
      - "9005:9000" # API Port (Moved to 9005 to avoid QuestDB conflict)
      - "9001:9001" # Web UI Console Port
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password123
    volumes:
      - minio_data:/data
    restart: always

  ingestor:
    build: ../services/ingestion
    container_name: upstox_ingestor
    depends_on:
      - kafka
    environment:
      # INTERNAL address for container-to-container
      - KAFKA_BOOTSTRAP_SERVERS=kafka_bus:9092 
    restart: always

  persistor:
    build: ../services/persistor
    container_name: market_persistor
    depends_on:
      - kafka
      - questdb
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka_bus:9092
    restart: always 

  feature_engine:
    build: ../services/feature_engine
    container_name: feature_engine
    depends_on:
      - kafka
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka_bus:9092
    restart: always

  strategy_runtime:
    build: ../services/strategy_runtime
    container_name: strategy_runtime
    depends_on:
      - kafka
      - postgres
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka_bus:9092
    restart: always
      
volumes:
  questdb_data:
  postgres_data:
  minio_data: